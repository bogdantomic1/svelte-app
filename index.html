<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <title>CT Form Capture Test</title>
    <!-- <script>
      (function (a, t, i) {
        var e = 'MSEI';
        var s = 'Analytics';
        var o = e + 'queue';
        a[o] = a[o] || [];
        var r =
          a[e] ||
          (function (n) {
            var t = {};
            t[s] = {};
            function e(e) {
              while (e.length) {
                var r = e.pop();
                t[s][r] = (function (e) {
                  return function () {
                    a[o].push([e, n, arguments]);
                  };
                })(r);
              }
            }
            var r = 'track';
            var i = 'set';
            e([
              r + 'Event',
              r + 'View',
              r + 'Action',
              i + 'Property',
              i + 'User',
              'initialize',
              'teardown',
            ]);
            return t;
          })(i.name);
        var n = i.name;
        if (!a[e]) {
          a[n] = r[s];
          a[o].push(['new', n]);
          setTimeout(function () {
            var e = 'script';
            var r = t.createElement(e);
            r.async = 1;
            r.src = i.src;
            var n = t.getElementsByTagName(e)[0];
            n.parentNode.insertBefore(r, n);
          }, 1);
        } else {
          a[n] = new r[s]();
        }
        if (i.user) {
          a[n].setUser(i.user);
        }
        if (i.props) {
          for (var c in i.props) {
            a[n].setProperty(c, i.props[c]);
          }
        }
        a[n].initialize(i.cfg);
      })(window, document, {
        src: 'https://download.pi.dynamics.com/sdk/web/msei-0.js',
        name: 'msdynmkt',
        cfg: {
          ingestionKey:
            'c233c22448aa4a799feedf6dd734d9c4-853de410-b103-4f95-91e2-b5d81be6e270-7136',
        },
      });
    </script> -->

    <link rel="icon" type="image/png" href="/svelte-app/favicon.png" />
    <link rel="stylesheet" href="/svelte-app/build/bundle.css" />

    <script defer src="/svelte-app/build/bundle.js"></script>

    <script>
      (function (a, t, i) {
        var e = "MSEI";
        var s = "Analytics";
        var o = e + "queue";
        a[o] = a[o] || [];
        var r =
          a[e] ||
          (function (n) {
            var t = {};
            t[s] = {};
            function e(e) {
              while (e.length) {
                var r = e.pop();
                t[s][r] = (function (e) {
                  return function () {
                    a[o].push([e, n, arguments]);
                  };
                })(r);
              }
            }
            var r = "track";
            var i = "set";
            e([
              r + "Event",
              r + "View",
              r + "Action",
              i + "Property",
              i + "User",
              "initialize",
              "teardown",
            ]);
            return t;
          })(i.name);
        var n = i.name;
        if (!a[e]) {
          a[n] = r[s];
          a[o].push(["new", n]);
          setTimeout(function () {
            var e = "script";
            var r = t.createElement(e);
            r.async = 1;
            r.src = i.src;
            var n = t.getElementsByTagName(e)[0];
            n.parentNode.insertBefore(r, n);
          }, 1);
        } else {
          a[n] = new r[s]();
        }
        if (i.user) {
          a[n].setUser(i.user);
        }
        if (i.props) {
          for (var c in i.props) {
            a[n].setProperty(c, i.props[c]);
          }
        }
        a[n].initialize(i.cfg);
      })(window, document, {
        src: "https://download.pi.dynamics.com/sdk/web/msei-0.js",
        name: "msdynmkt",
        cfg: {
          ingestionKey:
            "b1d765b9c293466bb1ef2ac825fc18f8-3d35c0db-60a3-4e5b-a38a-626cf4a27efb-7558",
        },
      });
    </script>
  </head>

  <body>
    <!-- <script src="https://mktdplp102cdn.azureedge.net/public/latest/js/form-loader.js?v=1.84.2007"></script>
	<div class="d365-mkt-config" style="display:none"
		data-website-id="Y_9U22dZLHhYN3_szL3TatVJ5IUKwHs3740htNlaYAk"
		data-hostname="3ef6b72440a5409d97e02ba917ada52d.svc.dynamics.com">
	</div> -->
    <!-- <script>
      var correlationID = null;
      function getCorrelationID(event) {
        if (event.data.msg === 'cid') {
          correlationID = event.data.data;
        }
      }
      window.addEventListener('message', getCorrelationID, false);
    </script>

    <script src="https://mktdplp102cdn.azureedge.net/public/latest/js/form-loader.js?v=1.84.2007"></script>
    <div
      class="d365-mkt-config"
      style="display: none"
      data-website-id="J4EpkawxUIKOE3hNpNJBh0DXFX3FLNWqg24-hhzuFuI"
      data-hostname="d795010597544199963642dac31315f9.svc.dynamics.com"
    ></div> -->

    <script src="https://cxppusa1formui01cdnsa01-endpoint.azureedge.net/eur/FormCapture/FormCapture.bundle.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    

    <script>
    

      document.addEventListener("DOMContentLoaded", () => {

        console.log("USAOOOOAOOAOAOAOOAO");
    
        function submitForm(form, mappings) {
        const serializedForm = d365mktformcapture.serializeForm(form, mappings);
        const payload = serializedForm.SerializedForm.build();

        const formedUrl =
            "https://public-eur.mkt.dynamics.com/api/v1.0/orgs/9bc5e4fe-4bda-ef11-b8e4-000d3ab73d5f/landingpageforms/forms/6b886942-0904-f011-bae3-7c1e5220bcad";

        if ($('#Email').val()) { //document.getElementById("Email").value.trim() !== ""
            fetch(formedUrl, {
                method: "post",
                headers: {
                    "Content-Type": "application/json;charset=UTF-8",
                },
                body: payload.data,
                keepalive: true,
            })
                .then(() => {
                    console.log("submission complete");
                })
                .catch((e) => {
                    console.log(e);
                });
        } else {console.log("nema");return;}
        }

    

        d365mktformcapture.waitForElement("#fakeFormTravel").then((form) => {
        const mappings = [
            {
                FormFieldName: "Packet",
                DataverseFieldName: "cr697_package",
                DataverseFieldValue: [
                    { FormValue: "206450000", DataverseValue: "0" },
                    { FormValue: "206450001", DataverseValue: "1" },
                    { FormValue: "206450002", DataverseValue: "2" },
                ],
            },
            {
                FormFieldName: "Taxnumber",
                DataverseFieldName: "cr697_taxnumber",
            },
            {
                FormFieldName: "Email",
                DataverseFieldName: "emailaddress1",
            },
            {
                FormFieldName: "FirstName",
                DataverseFieldName: "firstname",
            },
            {
                FormFieldName: "LastName",
                DataverseFieldName: "cr697_lastnamect",
            },
            {
                FormFieldName: "LastName",
                DataverseFieldName: "cr697_lastnameleadct",
            },
        ];

        // Define the pagehide event listener
       
        const handlePageHide = (e) => {
            // if (!e.persisted) {
            //     submitForm(form, mappings);
            // }
            submitForm(form, mappings);
        };
        // Attach pagehide event listener
        window.addEventListener("unload", handlePageHide);



        

    });
    

  });
    </script>
  </body>
</html>
